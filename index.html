<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FicLib Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-900 text-gray-100 font-sans antialiased">

    <nav class="fixed bottom-0 w-full bg-gray-800 border-t border-gray-700 flex justify-around py-3 z-50 safe-area-pb">
        <button onclick="switchTab('library')" class="text-center text-gray-400 hover:text-blue-400 focus:text-blue-500 nav-btn" id="btn-library">
            <i class="fa-solid fa-book text-xl"></i>
            <span class="block text-xs mt-1">Library</span>
        </button>
        <button onclick="switchTab('dashboard')" class="text-center text-gray-400 hover:text-blue-400 focus:text-blue-500 nav-btn" id="btn-dashboard">
            <i class="fa-solid fa-chart-simple text-xl"></i>
            <span class="block text-xs mt-1">Dashboard</span>
        </button>
        <button onclick="switchTab('settings')" class="text-center text-gray-400 hover:text-blue-400 focus:text-blue-500 nav-btn" id="btn-settings">
            <i class="fa-solid fa-gear text-xl"></i>
            <span class="block text-xs mt-1">Data</span>
        </button>
    </nav>

    <main class="pb-24 pt-6 px-4 max-w-md mx-auto min-h-screen">
        
        <div id="tab-library" class="tab-content">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-2xl font-bold">FicLib</h1>
                <button onclick="openAddModal()" class="bg-blue-600 text-white p-2 rounded-full w-10 h-10 shadow-lg">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <div class="space-y-2 mb-4">
                <input type="text" id="searchInput" placeholder="Search title, ship, tag..." 
                       class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-white focus:outline-none focus:border-blue-500"
                       onkeyup="renderLibrary()">
                
                <div class="flex gap-2 overflow-x-auto pb-2">
                    <select id="filterStatus" onchange="renderLibrary()" class="bg-gray-800 border border-gray-700 rounded-lg p-2 text-sm">
                        <option value="all">All Statuses</option>
                        <option value="read">Read</option>
                        <option value="unread">Unread</option>
                    </select>
                    <select id="sortOption" onchange="renderLibrary()" class="bg-gray-800 border border-gray-700 rounded-lg p-2 text-sm">
                        <option value="date">Newest</option>
                        <option value="az">Title A-Z</option>
                        <option value="words">Word Count</option>
                    </select>
                </div>
            </div>

            <div id="ficList" class="space-y-3">
                </div>
        </div>

        <div id="tab-dashboard" class="tab-content hidden">
            <h1 class="text-2xl font-bold mb-6">Dashboard</h1>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-800 p-4 rounded-xl text-center">
                    <p class="text-gray-400 text-xs uppercase">Words Read</p>
                    <p class="text-2xl font-bold text-white mt-1" id="stat-words">0</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl text-center">
                    <p class="text-gray-400 text-xs uppercase">Fics Tracked</p>
                    <p class="text-2xl font-bold text-white mt-1" id="stat-total">0</p>
                </div>
            </div>

            <div class="bg-gray-800 p-4 rounded-xl mb-6">
                <div class="flex justify-between text-xs text-gray-400 mb-2">
                    <span id="stat-read-count">Read: 0</span>
                    <span id="stat-unread-count">Unread: 0</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-2.5">
                    <div id="stat-progress-bar" class="bg-green-500 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <div class="space-y-6">
                <div>
                    <h3 class="text-lg font-semibold mb-3">Top Fandoms (Read)</h3>
                    <div id="list-top-fandoms" class="space-y-2"></div>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-3">Top Ships (Read)</h3>
                    <div id="list-top-ships" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <div id="tab-settings" class="tab-content hidden">
            <h1 class="text-2xl font-bold mb-6">Data Management</h1>
            
            <div class="bg-gray-800 p-6 rounded-xl space-y-6">
                <div class="border-b border-gray-700 pb-6">
                    <h3 class="font-bold mb-2">Import Data</h3>
                    <p class="text-sm text-gray-400 mb-4">Upload your 'database.json' file to get started. Data stays on this device.</p>
                    <input type="file" id="fileInput" accept=".json" class="block w-full text-sm text-gray-400
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-full file:border-0
                        file:text-sm file:font-semibold
                        file:bg-blue-600 file:text-white
                        hover:file:bg-blue-700
                    "/>
                </div>

                <div>
                    <h3 class="font-bold mb-2">Export Data</h3>
                    <p class="text-sm text-gray-400 mb-4">Download your updated list as a JSON file backup.</p>
                    <button onclick="exportData()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">
                        <i class="fa-solid fa-download mr-2"></i> Download JSON
                    </button>
                </div>
                
                <div class="pt-4">
                    <button onclick="clearData()" class="w-full border border-red-500 text-red-500 hover:bg-red-500 hover:text-white font-bold py-2 px-4 rounded-lg transition">
                        Reset App (Clear All)
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="ficModal" class="fixed inset-0 bg-black bg-opacity-90 hidden z-50 flex items-center justify-center p-4 overflow-y-auto">
        <div class="bg-gray-800 rounded-xl w-full max-w-lg p-6 relative">
            <h2 id="modalTitle" class="text-xl font-bold mb-4">Add Fic</h2>
            <form id="ficForm" class="space-y-4">
                <input type="hidden" id="editId">
                
                <input type="text" id="inpTitle" placeholder="Title" class="w-full bg-gray-700 p-3 rounded border border-gray-600 text-white" required>
                <div class="grid grid-cols-2 gap-4">
                    <input type="text" id="inpAuthor" placeholder="Author" class="w-full bg-gray-700 p-3 rounded border border-gray-600 text-white">
                    <input type="text" id="inpFandom" placeholder="Fandom" class="w-full bg-gray-700 p-3 rounded border border-gray-600 text-white">
                </div>
                <input type="url" id="inpLink" placeholder="Link (AO3/Wattpad)" class="w-full bg-gray-700 p-3 rounded border border-gray-600 text-white">
                
                <div class="grid grid-cols-2 gap-4">
                    <select id="inpReadStatus" class="w-full bg-gray-700 p-3 rounded border border-gray-600 text-white">
                        <option value="unread">Unread</option>
                        <option value="read">Read</option>
                    </select>
                    <select id="inpCoverStatus" class="w-full bg-gray-700 p-3 rounded border border-gray-600 text-white">
                        <option value="not">No Cover</option>
                        <option value="yes">Cover Made</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="inpWords" placeholder="Word Count" class="w-full bg-gray-700 p-3 rounded border border-gray-600 text-white">
                    <input type="number" id="inpChapters" placeholder="Chapters" class="w-full bg-gray-700 p-3 rounded border border-gray-600 text-white">
                </div>

                <textarea id="inpSummary" placeholder="Summary" rows="3" class="w-full bg-gray-700 p-3 rounded border border-gray-600 text-white"></textarea>
                
                <input type="text" id="inpShips" placeholder="Ships (Draco/Hermione, Harry/Ginny)" class="w-full bg-gray-700 p-3 rounded border border-gray-600 text-white">
                <input type="text" id="inpTags" placeholder="Tags (Angst, Fluff)" class="w-full bg-gray-700 p-3 rounded border border-gray-600 text-white">

                <div class="flex justify-end gap-3 mt-4">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-400 hover:text-white">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- DATA STORE ---
        let fics = [];

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Try loading from Local Storage
            const storedData = localStorage.getItem('ficLibData');
            if (storedData) {
                fics = JSON.parse(storedData);
                renderLibrary();
                updateStats();
            }
            
            // 2. Set up File Import Listener
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            
            // 3. Set up Form Submit
            document.getElementById('ficForm').addEventListener('submit', handleFormSubmit);
        });

        // --- TAB SWITCHING ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            
            // Update Active Icon Color
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('text-blue-500'));
            document.getElementById(`btn-${tabName}`).classList.add('text-blue-500');
            
            if(tabName === 'dashboard') updateStats();
        }

        // --- DATA PERSISTENCE ---
        function saveData() {
            localStorage.setItem('ficLibData', JSON.stringify(fics));
            renderLibrary();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    // Support both raw array or the structure from your swift app
                    if (Array.isArray(json)) {
                        fics = json;
                    } else if (json.fics) {
                        fics = json.fics;
                    }
                    saveData();
                    alert(`Imported ${fics.length} fics successfully!`);
                    switchTab('library');
                } catch (err) {
                    alert("Error parsing JSON file");
                }
            };
            reader.readAsText(file);
        }

        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(fics, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "my_fics_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
        
        function clearData() {
            if(confirm("Are you sure? This deletes everything.")) {
                fics = [];
                saveData();
            }
        }

        // --- RENDERING LIBRARY ---
        function renderLibrary() {
            const list = document.getElementById('ficList');
            list.innerHTML = '';
            
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const sortMode = document.getElementById('sortOption').value;

            // Filter
            let filtered = fics.filter(fic => {
                // Filter by status
                if (statusFilter !== 'all' && (fic.reread_status || fic.rereadStatus || 'unread').toLowerCase() !== statusFilter) return false;
                
                // Search
                if (searchText) {
                    const content = `${fic.title} ${fic.fandom} ${fic.author} ${(fic.ships||[]).join(' ')} ${(fic.tags||[]).join(' ')}`.toLowerCase();
                    return content.includes(searchText);
                }
                return true;
            });

            // Sort
            filtered.sort((a, b) => {
                if (sortMode === 'az') return a.title.localeCompare(b.title);
                if (sortMode === 'words') return (b.wordcount || 0) - (a.wordcount || 0);
                return 0; // Default creation order (approx)
            });

            // Render
            filtered.forEach(fic => {
                // Handle mixed camelCase/snake_case from swift export
                const isRead = (fic.reread_status === 'read' || fic.rereadStatus === 'read');
                const hasCover = (fic.cover_status === 'yes' || fic.coverStatus === 'yes');
                
                const item = document.createElement('div');
                item.className = 'bg-gray-800 p-4 rounded-xl shadow flex justify-between items-start cursor-pointer hover:bg-gray-750 transition';
                item.onclick = () => openEditModal(fic.id);
                
                item.innerHTML = `
                    <div class="flex-1">
                        <h3 class="font-bold text-white leading-tight">${fic.title}</h3>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs font-medium px-2 py-0.5 rounded bg-purple-900 text-purple-200">${fic.fandom}</span>
                            ${isRead ? '<i class="fa-solid fa-circle-check text-green-500 text-sm"></i>' : ''}
                            ${hasCover ? '<i class="fa-solid fa-image text-yellow-600 text-sm"></i>' : ''}
                        </div>
                        <p class="text-xs text-gray-400 mt-2 line-clamp-1">${fic.author} â€¢ ${(fic.ships || []).join(', ')}</p>
                    </div>
                    <div class="text-right pl-2">
                        <p class="text-xs text-gray-500 font-mono">${(fic.wordcount || 0).toLocaleString()}w</p>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // --- MODAL LOGIC ---
        function openAddModal() {
            document.getElementById('ficForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('modalTitle').innerText = 'Add New Fic';
            document.getElementById('ficModal').classList.remove('hidden');
        }

        function openEditModal(id) {
            const fic = fics.find(f => f.id === id);
            if(!fic) return;

            document.getElementById('editId').value = fic.id;
            document.getElementById('modalTitle').innerText = 'Edit Fic';
            
            document.getElementById('inpTitle').value = fic.title;
            document.getElementById('inpAuthor').value = fic.author || '';
            document.getElementById('inpFandom').value = fic.fandom || '';
            document.getElementById('inpLink').value = fic.originalLink || fic.original_link || '';
            document.getElementById('inpReadStatus').value = fic.rereadStatus || fic.reread_status || 'unread';
            document.getElementById('inpCoverStatus').value = fic.coverStatus || fic.cover_status || 'not';
            document.getElementById('inpWords').value = fic.wordcount || '';
            document.getElementById('inpChapters').value = fic.chapters || '';
            document.getElementById('inpSummary').value = fic.summary || '';
            document.getElementById('inpShips').value = (fic.ships || []).join(', ');
            document.getElementById('inpTags').value = (fic.tags || []).join(', ');

            document.getElementById('ficModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('ficModal').classList.add('hidden');
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            
            // Create/Update Object
            const formData = {
                id: id || crypto.randomUUID(),
                title: document.getElementById('inpTitle').value,
                author: document.getElementById('inpAuthor').value,
                fandom: document.getElementById('inpFandom').value,
                originalLink: document.getElementById('inpLink').value,
                rereadStatus: document.getElementById('inpReadStatus').value,
                coverStatus: document.getElementById('inpCoverStatus').value,
                wordcount: parseInt(document.getElementById('inpWords').value) || 0,
                chapters: parseInt(document.getElementById('inpChapters').value) || 0,
                summary: document.getElementById('inpSummary').value,
                ships: document.getElementById('inpShips').value.split(',').map(s => s.trim()).filter(s => s),
                tags: document.getElementById('inpTags').value.split(',').map(s => s.trim()).filter(s => s),
                status: 'wip' // default
            };

            if (id) {
                const index = fics.findIndex(f => f.id === id);
                fics[index] = { ...fics[index], ...formData };
            } else {
                fics.unshift(formData);
            }

            saveData();
            closeModal();
        }

        // --- STATS LOGIC ---
        function updateStats() {
            // 1. Total Fics
            document.getElementById('stat-total').innerText = fics.length;

            // Filter Read Fics
            const readFics = fics.filter(f => (f.rereadStatus === 'read' || f.reread_status === 'read'));
            
            // 2. Words Read
            const totalWords = readFics.reduce((sum, f) => sum + (f.wordcount || 0), 0);
            document.getElementById('stat-words').innerText = totalWords.toLocaleString();

            // 3. Progress Bar
            const readCount = readFics.length;
            const unreadCount = fics.length - readCount;
            document.getElementById('stat-read-count').innerText = `Read: ${readCount}`;
            document.getElementById('stat-unread-count').innerText = `Unread: ${unreadCount}`;
            
            const pct = fics.length ? (readCount / fics.length) * 100 : 0;
            document.getElementById('stat-progress-bar').style.width = `${pct}%`;

            // 4. Helpers for Top Lists
            const getTop = (items, mapFn) => {
                const counts = {};
                items.forEach(item => {
                    const keys = mapFn(item);
                    // Handle both array (ships/tags) and string (fandom)
                    if(Array.isArray(keys)) {
                        keys.forEach(k => counts[k] = (counts[k] || 0) + 1);
                    } else if (keys) {
                        counts[keys] = (counts[keys] || 0) + 1;
                    }
                });
                return Object.entries(counts)
                    .sort((a,b) => b[1] - a[1])
                    .slice(0, 5);
            };

            // Top Fandoms
            const topFandoms = getTop(readFics, f => f.fandom);
            renderTopList('list-top-fandoms', topFandoms);

            // Top Ships
            const topShips = getTop(readFics, f => f.ships);
            renderTopList('list-top-ships', topShips);
        }

        function renderTopList(elementId, data) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No data found</p>';
                return;
            }
            data.forEach(([name, count]) => {
                container.innerHTML += `
                    <div class="flex justify-between text-sm border-b border-gray-700 pb-1 last:border-0">
                        <span class="text-white font-medium truncate w-3/4">${name}</span>
                        <span class="text-gray-400">${count}</span>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
