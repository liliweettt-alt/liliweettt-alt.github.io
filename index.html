<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FicLib</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Poppins:wght@500;700&display=swap" rel="stylesheet">

    <style>
        /* BASE SETTINGS */
        :root {
            --bg-body: #0f172a; /* Slate 900 */
            --bg-card: #1e293b; /* Slate 800 */
            --bg-input: #334155; /* Slate 700 */
            --accent: #818cf8; /* Indigo 400 */
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: #f1f5f9; }
        h1, h2, h3, .font-heading { font-family: 'Poppins', sans-serif; }
        
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input[type="date"] { color-scheme: dark; }

        /* GLASS NAVIGATION */
        .glass-nav {
            background-color: rgba(15, 23, 42, 0.90);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        /* CARDS */
        .fic-card {
            background-color: var(--bg-card);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .fic-card:active { transform: scale(0.98); }

        /* SERIES FOLDER */
        .series-folder {
            background-color: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(129, 140, 248, 0.3);
            position: relative;
        }
        .series-folder::before {
            content: '';
            position: absolute;
            top: -4px;
            right: 10px;
            left: 10px;
            height: 4px;
            background: rgba(129, 140, 248, 0.2);
            border-radius: 4px 4px 0 0;
        }

        /* PIE CHART */
        .pie-chart {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: conic-gradient(var(--bg-input) 0% 100%);
            position: relative;
        }
        .pie-hole {
            width: 80px;
            height: 80px;
            background-color: var(--bg-card);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #94a3b8;
        }

        /* INPUTS */
        .input-field { 
            width: 100%; 
            background-color: var(--bg-input); 
            padding: 0.8rem; 
            border-radius: 0.75rem; 
            border: 1px solid rgba(255,255,255,0.1); 
            color: white; 
            font-size: 0.9rem; 
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }
        .input-field:focus { outline: none; border-color: var(--accent); }

        /* CUSTOM SELECT */
        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.2em 1.2em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            appearance: none;
        }

        /* BADGES */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.15rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .tag-chip {
            font-size: 0.7rem;
            background: rgba(255,255,255,0.05);
            padding: 2px 8px;
            border-radius: 4px;
            color: #94a3b8;
        }

        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="antialiased selection:bg-indigo-500 selection:text-white">

    <nav class="fixed bottom-0 w-full glass-nav flex justify-around py-3 z-50 safe-area-pb shadow-[0_-5px_15px_rgba(0,0,0,0.3)]">
        <button onclick="switchTab('library')" class="nav-btn text-center text-indigo-400 transition-colors" id="btn-library">
            <i class="fa-solid fa-book-open text-lg mb-0.5"></i>
            <span class="block text-[9px] font-heading tracking-wide">Library</span>
        </button>
        <button onclick="switchTab('discovery')" class="nav-btn text-center text-slate-500 hover:text-indigo-300 transition-colors" id="btn-discovery">
            <i class="fa-solid fa-compass text-lg mb-0.5"></i>
            <span class="block text-[9px] font-heading tracking-wide">Pick</span>
        </button>
        <button onclick="switchTab('dashboard')" class="nav-btn text-center text-slate-500 hover:text-indigo-300 transition-colors" id="btn-dashboard">
            <i class="fa-solid fa-chart-pie text-lg mb-0.5"></i>
            <span class="block text-[9px] font-heading tracking-wide">Stats</span>
        </button>
        <button onclick="switchTab('settings')" class="nav-btn text-center text-slate-500 hover:text-indigo-300 transition-colors" id="btn-settings">
            <i class="fa-solid fa-sliders text-lg mb-0.5"></i>
            <span class="block text-[9px] font-heading tracking-wide">Data</span>
        </button>
    </nav>

    <main class="pb-32 pt-8 px-5 max-w-md mx-auto min-h-screen">
        
        <div id="tab-library" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-purple-400">FicLib</h1>
                    <p class="text-slate-400 text-xs mt-1">Your reading universe</p>
                </div>
                <button onclick="openAddModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white w-10 h-10 rounded-full shadow-lg shadow-indigo-500/30 flex items-center justify-center transition-all transform hover:scale-105">
                    <i class="fa-solid fa-plus text-lg"></i>
                </button>
            </div>

            <div class="space-y-3 mb-6">
                <div class="relative">
                    <i class="fa-solid fa-search absolute left-3 top-3.5 text-slate-500 text-sm"></i>
                    <input type="text" id="searchInput" placeholder="Search title, series, tags..." 
                           class="input-field pl-9"
                           onkeyup="renderLibrary()">
                </div>
                
                <div class="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                    <select id="filterStatus" onchange="renderLibrary()" class="input-field py-2 text-xs w-auto whitespace-nowrap custom-select">
                        <option value="all">Reading: All</option>
                        <option value="read">Read</option>
                        <option value="unread">Unread</option>
                    </select>
                    <select id="filterShips" onchange="renderLibrary()" class="input-field py-2 text-xs w-auto whitespace-nowrap custom-select">
                        <option value="all">Ship: All</option>
                    </select>
                    <select id="filterTags" onchange="renderLibrary()" class="input-field py-2 text-xs w-auto whitespace-nowrap custom-select">
                        <option value="all">Tag: All</option>
                    </select>
                    <select id="filterChapters" onchange="renderLibrary()" class="input-field py-2 text-xs w-auto whitespace-nowrap custom-select">
                        <option value="all">Length: Any</option>
                        <option value="short">Short (<10)</option>
                        <option value="medium">Medium (10-50)</option>
                        <option value="long">Long (>50)</option>
                    </select>
                    <select id="sortOption" onchange="renderLibrary()" class="input-field py-2 text-xs w-auto whitespace-nowrap custom-select">
                        <option value="date">Newest</option>
                        <option value="az">A-Z</option>
                        <option value="words">Word Count</option>
                    </select>
                </div>
            </div>

            <div id="ficList" class="space-y-3"></div>
        </div>

        <div id="tab-discovery" class="tab-content hidden animate-fade-in">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h1 class="text-2xl font-bold text-white">Next Read</h1>
                    <p class="text-slate-400 text-xs">Unread gems from your list</p>
                </div>
                <button onclick="renderDiscovery()" class="text-xs bg-slate-800 hover:bg-slate-700 border border-slate-700 text-indigo-400 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-2">
                    <i class="fa-solid fa-shuffle"></i> Spin Again
                </button>
            </div>
            <div id="discoveryList" class="space-y-6"></div>
        </div>

        <div id="tab-dashboard" class="tab-content hidden animate-fade-in">
            <h1 class="text-2xl font-bold mb-6">Your Stats</h1>
            
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 text-center shadow-sm">
                    <div class="w-10 h-10 bg-indigo-500/10 rounded-full flex items-center justify-center mx-auto mb-2 text-indigo-400">
                        <i class="fa-solid fa-book-open"></i>
                    </div>
                    <p class="text-slate-400 text-[10px] uppercase tracking-wider font-bold">Words Read</p>
                    <p class="text-xl font-bold text-white mt-1" id="stat-words">0</p>
                </div>
                <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 text-center shadow-sm">
                    <div class="w-10 h-10 bg-purple-500/10 rounded-full flex items-center justify-center mx-auto mb-2 text-purple-400">
                        <i class="fa-solid fa-layer-group"></i>
                    </div>
                    <p class="text-slate-400 text-[10px] uppercase tracking-wider font-bold">Total Fics</p>
                    <p class="text-xl font-bold text-white mt-1" id="stat-total">0</p>
                </div>
            </div>

            <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 mb-8">
                <div class="flex justify-between text-xs text-slate-400 mb-3 font-semibold">
                    <span id="stat-read-count">Read: 0</span>
                    <span id="stat-unread-count">Unread: 0</span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-3 overflow-hidden">
                    <div id="stat-progress-bar" class="bg-gradient-to-r from-indigo-500 to-purple-500 h-3 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                </div>
            </div>

            <h3 class="text-sm font-bold text-slate-300 mb-4 uppercase tracking-wide border-b border-slate-700 pb-2">General Stats</h3>
            <div class="space-y-6 mb-8">
                <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 flex items-center gap-6">
                    <div id="pie-fandoms" class="pie-chart shrink-0"><div class="pie-hole">Fandoms</div></div>
                    <div class="flex-1">
                        <h4 class="font-bold text-white mb-2 text-sm">Top Fandoms</h4>
                        <div id="legend-fandoms" class="space-y-1"></div>
                    </div>
                </div>
                <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 flex items-center gap-6">
                    <div id="pie-ships" class="pie-chart shrink-0"><div class="pie-hole">Ships</div></div>
                    <div class="flex-1">
                        <h4 class="font-bold text-white mb-2 text-sm">Top Ships</h4>
                        <div id="legend-ships" class="space-y-1"></div>
                    </div>
                </div>
                <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 flex items-center gap-6">
                    <div id="pie-tags" class="pie-chart shrink-0"><div class="pie-hole">Tags</div></div>
                    <div class="flex-1">
                        <h4 class="font-bold text-white mb-2 text-sm">Top Tags</h4>
                        <div id="legend-tags" class="space-y-1"></div>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                    <h3 class="text-sm font-bold text-slate-300 uppercase tracking-wide">Yearly Archive</h3>
                    <select id="yearSelect" onchange="renderYearlyStats()" class="bg-slate-800 text-indigo-400 text-xs font-bold border border-slate-600 rounded-lg px-2 py-1 focus:outline-none">
                        </select>
                </div>
                
                <div id="yearlyStatsContainer" class="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                    <p class="text-slate-500 text-center text-sm">Select a year to view details.</p>
                </div>
            </div>
        </div>

        <div id="tab-settings" class="tab-content hidden animate-fade-in">
            <h1 class="text-2xl font-bold mb-6">Data Management</h1>
            <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 space-y-6">
                <div>
                    <h3 class="font-bold mb-3 text-sm text-indigo-300">Import Library</h3>
                    <input type="file" id="fileInput" accept=".json" class="block w-full text-sm text-slate-400 file:mr-4 file:py-2.5 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-bold file:bg-indigo-600 file:text-white hover:file:bg-indigo-500 cursor-pointer"/>
                </div>
                <div>
                    <h3 class="font-bold mb-3 text-sm text-indigo-300">Export Backup</h3>
                    <button onclick="exportData()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-4 rounded-xl text-sm transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-download"></i> Download JSON
                    </button>
                </div>
                <div class="pt-6 border-t border-slate-700">
                    <button onclick="clearData()" class="w-full text-red-400 hover:text-red-300 text-sm font-semibold flex items-center justify-center gap-2">
                        <i class="fa-solid fa-trash"></i> Delete All Data
                    </button>
                </div>
            </div>
        </div>
    </main>

    <div id="ficModal" class="fixed inset-0 bg-slate-950/80 backdrop-blur-sm hidden z-[100] flex items-end sm:items-center justify-center p-0 sm:p-4 transition-opacity duration-300">
        <div class="bg-slate-800 w-full sm:max-w-lg sm:rounded-2xl rounded-t-3xl p-6 h-[90vh] sm:h-auto overflow-y-auto shadow-2xl border border-slate-700/50">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-slate-800 z-10 pb-2 border-b border-slate-700">
                <h2 id="modalTitle" class="text-xl font-bold font-heading text-white">Add Fic</h2>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-slate-700 text-slate-300 hover:bg-slate-600 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            
            <form id="ficForm" class="space-y-4 pb-20">
                <input type="hidden" id="editId">
                <input type="text" id="inpTitle" placeholder="Fic Title" class="input-field text-lg font-bold placeholder-slate-500" required>
                
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="inpAuthor" placeholder="Author" class="input-field">
                    <input type="text" id="inpFandom" placeholder="Fandom" class="input-field">
                </div>

                <div class="grid grid-cols-4 gap-3 bg-slate-700/30 p-2 rounded-lg border border-slate-700">
                    <div class="col-span-3">
                        <input type="text" id="inpSeries" placeholder="Series Name (Optional)" class="input-field text-sm bg-slate-800">
                    </div>
                    <div class="relative">
                        <span class="absolute right-2 top-3 text-[10px] text-slate-500">Part#</span>
                        <input type="number" id="inpSeriesPart" placeholder="1" class="input-field text-sm bg-slate-800">
                    </div>
                </div>
                
                <div class="relative">
                     <i class="fa-solid fa-link absolute left-3 top-3.5 text-slate-500 text-xs"></i>
                    <input type="url" id="inpLink" placeholder="AO3 / Wattpad Link" class="input-field pl-8 text-sm">
                </div>
                
                <div class="p-4 bg-slate-700/30 rounded-xl space-y-3 border border-slate-700">
                    <div class="grid grid-cols-2 gap-3">
                        <select id="inpReadStatus" class="input-field custom-select bg-slate-800" onchange="toggleDateVisibility()">
                            <option value="unread">Unread</option>
                            <option value="read">Read</option>
                        </select>
                         <select id="inpStatus" class="input-field custom-select bg-slate-800">
                            <option value="wip">WIP</option>
                            <option value="complete">Complete</option>
                        </select>
                    </div>
                    <div id="divDateFinished" class="hidden w-full animate-fade-in">
                        <label class="text-xs text-emerald-400 font-bold ml-1 mb-1 block">Date Finished</label>
                        <input type="date" id="inpDateFinished" class="input-field bg-slate-800">
                    </div>
                    <select id="inpCoverStatus" class="input-field custom-select bg-slate-800">
                        <option value="not">No Cover</option>
                        <option value="yes">Cover Made</option>
                    </select>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="relative">
                        <span class="absolute right-3 top-3 text-xs text-slate-500">words</span>
                        <input type="number" id="inpWords" placeholder="0" class="input-field">
                    </div>
                    <div class="relative">
                        <span class="absolute right-3 top-3 text-xs text-slate-500">ch.</span>
                        <input type="number" id="inpChapters" placeholder="0" class="input-field">
                    </div>
                </div>

                <div class="space-y-3">
                    <div>
                        <label class="text-xs font-bold text-slate-400 ml-1 uppercase tracking-wide">Summary</label>
                        <textarea id="inpSummary" placeholder="Paste official summary..." rows="3" class="input-field text-sm leading-relaxed text-slate-300"></textarea>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-indigo-400 ml-1 uppercase tracking-wide"><i class="fa-regular fa-note-sticky mr-1"></i> My Notes</label>
                        <textarea id="inpNotes" placeholder="Personal thoughts, to-read notes..." rows="2" class="input-field border-indigo-500/30 bg-indigo-500/5 text-sm"></textarea>
                    </div>
                </div>
                
                <div class="space-y-3 pt-2 border-t border-slate-700">
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-xs text-slate-400 ml-1 font-bold">Ships</label>
                            <select id="selShipsHelper" class="bg-slate-700 text-[10px] text-indigo-300 border-none rounded px-2 py-1 max-w-[120px] custom-select focus:ring-0" onchange="pickSuggestion('inpShips', 'selShipsHelper')">
                                <option value="">Select used...</option>
                            </select>
                        </div>
                        <textarea id="inpShips" placeholder="e.g. Draco/Hermione" rows="1" class="input-field text-sm"></textarea>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-xs text-slate-400 ml-1 font-bold">Tags</label>
                            <select id="selTagsHelper" class="bg-slate-700 text-[10px] text-indigo-300 border-none rounded px-2 py-1 max-w-[120px] custom-select focus:ring-0" onchange="pickSuggestion('inpTags', 'selTagsHelper')">
                                <option value="">Select used...</option>
                            </select>
                        </div>
                        <textarea id="inpTags" placeholder="e.g. Slow Burn, AU" rows="1" class="input-field text-sm"></textarea>
                    </div>
                </div>

                <div class="flex gap-3 mt-6 pt-4 border-t border-slate-700">
                    <button type="button" id="btnDelete" onclick="deleteFic()" class="hidden bg-red-500/10 hover:bg-red-500/20 text-red-400 p-3 rounded-xl font-bold w-1/4 transition-colors border border-red-500/20">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                    <button type="submit" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white p-3 rounded-xl font-bold flex-1 shadow-lg shadow-indigo-500/25 transition-all transform active:scale-95">Save Fic</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let fics = [];

        document.addEventListener('DOMContentLoaded', () => {
            const stored = localStorage.getItem('ficLibData');
            if (stored) {
                fics = JSON.parse(stored);
                // Data Normalization
                fics.forEach(f => {
                    if(f.cover_status) { f.coverStatus = f.cover_status; delete f.cover_status; }
                    if(f.reread_status) { f.rereadStatus = f.reread_status; delete f.reread_status; }
                    if(f.date_finished) { f.dateFinished = f.date_finished; delete f.date_finished; }
                });
                populateFilterDropdowns(); // Init filters ONCE
                renderLibrary();
            }
            document.getElementById('fileInput').addEventListener('change', handleFileUpload);
            document.getElementById('ficForm').addEventListener('submit', handleFormSubmit);
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(el => {
                el.classList.remove('text-indigo-400');
                el.classList.add('text-slate-500');
            });
            const activeBtn = document.getElementById(`btn-${tab}`);
            activeBtn.classList.remove('text-slate-500');
            activeBtn.classList.add('text-indigo-400');
            
            if(tab === 'dashboard') updateDashboard();
            if(tab === 'discovery') renderDiscovery();
            
            window.scrollTo(0,0);
        }

        function saveData() {
            localStorage.setItem('ficLibData', JSON.stringify(fics));
            populateFilterDropdowns(); // Update filters on save
            renderLibrary(); 
        }

        // --- DYNAMIC FILTERS ---
        function populateFilterDropdowns() {
            const shipSet = new Set();
            const tagSet = new Set();
            fics.forEach(f => {
                (f.ships || []).forEach(s => shipSet.add(s.trim()));
                (f.tags || []).forEach(t => tagSet.add(t.trim()));
            });

            const fill = (id, items, label) => {
                const select = document.getElementById(id);
                const currentVal = select.value;
                select.innerHTML = `<option value="all">${label}</option>`;
                items.sort((a,b) => a.localeCompare(b)).forEach(i => {
                    if(!i) return;
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.innerText = i;
                    select.appendChild(opt);
                });
                if(items.includes(currentVal)) select.value = currentVal;
            };

            fill('filterShips', Array.from(shipSet), 'Ship: All');
            fill('filterTags', Array.from(tagSet), 'Tag: All');
        }

        // --- RENDER LIBRARY ---
        function renderLibrary() {
            const list = document.getElementById('ficList');
            list.innerHTML = '';
            
            const search = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const chapterFilter = document.getElementById('filterChapters').value;
            const completionFilter = document.getElementById('filterCompletion').value;
            const coverFilter = document.getElementById('filterCover').value;
            const shipFilter = document.getElementById('filterShips').value;
            const tagFilter = document.getElementById('filterTags').value;
            const sortMode = document.getElementById('sortOption').value;

            // 1. Filter
            let filtered = fics.filter(f => {
                if (statusFilter !== 'all' && (f.rereadStatus || 'unread').toLowerCase() !== statusFilter) return false;
                
                const chaps = f.chapters || 0;
                if (chapterFilter === 'short' && chaps >= 10) return false;
                if (chapterFilter === 'medium' && (chaps < 10 || chaps > 50)) return false;
                if (chapterFilter === 'long' && chaps <= 50) return false;

                if (completionFilter !== 'all' && (f.status || 'wip').toLowerCase() !== completionFilter) return false;
                if (coverFilter !== 'all') {
                    const hasCover = (f.coverStatus === 'yes');
                    if (coverFilter === 'yes' && !hasCover) return false;
                    if (coverFilter === 'not' && hasCover) return false;
                }
                if (shipFilter !== 'all' && (!f.ships || !f.ships.includes(shipFilter))) return false;
                if (tagFilter !== 'all' && (!f.tags || !f.tags.includes(tagFilter))) return false;

                if (search) {
                    const txt = `${f.title} ${f.series || ''} ${f.fandom} ${f.author} ${(f.ships||[]).join(' ')} ${(f.tags||[]).join(' ')}`.toLowerCase();
                    return txt.includes(search);
                }
                return true;
            });

            // 2. Group Series
            const groups = {};
            const displayList = [];

            filtered.forEach(f => {
                if(f.series && f.series.trim() !== "") {
                    const sName = f.series.trim();
                    if(!groups[sName]) groups[sName] = [];
                    groups[sName].push(f);
                } else {
                    displayList.push({ type: 'fic', data: f });
                }
            });

            // 3. Process Series Objects
            Object.keys(groups).forEach(seriesName => {
                const seriesFics = groups[seriesName];
                seriesFics.sort((a,b) => (a.seriesPart || 0) - (b.seriesPart || 0));
                
                const dates = seriesFics.map(f => f.dateFinished ? parseDateLocal(f.dateFinished).getTime() : 0);
                const latest = Math.max(...dates);

                displayList.push({
                    type: 'series',
                    title: seriesName,
                    fandom: seriesFics[0].fandom,
                    author: seriesFics[0].author,
                    totalWords: seriesFics.reduce((sum, f) => sum + (f.wordcount||0), 0),
                    items: seriesFics,
                    latestTimestamp: latest
                });
            });

            // 4. Sort Display List
            displayList.sort((a, b) => {
                const getTs = (item) => {
                    if(item.type === 'series') return item.latestTimestamp || 0;
                    return item.data.dateFinished ? parseDateLocal(item.data.dateFinished).getTime() : 0;
                };
                const getWords = (item) => item.type === 'series' ? item.totalWords : (item.data.wordcount||0);
                const getTitle = (item) => item.type === 'series' ? item.title : item.data.title;

                if (sortMode === 'az') return getTitle(a).localeCompare(getTitle(b));
                if (sortMode === 'words') return getWords(b) - getWords(a);
                return getTs(b) - getTs(a); 
            });

            // 5. Render
            displayList.forEach(item => {
                if (item.type === 'fic') {
                    renderFicCard(item.data, list);
                } else {
                    renderSeriesCard(item, list);
                }
            });
        }

        function renderFicCard(f, container) {
            const isRead = f.rereadStatus === 'read';
            const hasCover = f.coverStatus === 'yes';
            const isComplete = (f.status || 'wip').toLowerCase() === 'complete';
            
            const statusBadge = isComplete 
                ? '<span class="badge bg-emerald-900/30 text-emerald-400 border border-emerald-500/30">Complete</span>' 
                : '<span class="badge bg-amber-900/30 text-amber-400 border border-amber-500/30">WIP</span>';
            const coverBadge = hasCover 
                ? '<span class="badge bg-yellow-500/10 text-yellow-500 border border-yellow-500/20"><i class="fa-solid fa-image mr-1"></i> Cover</span>' 
                : '';
            
            const seriesHtml = (f.series && f.series.trim() !== "") 
                ? `<div class="text-[10px] text-indigo-300 font-bold mb-0.5 tracking-wide"><i class="fa-solid fa-layer-group mr-1"></i>Part ${f.seriesPart}</div>` 
                : '';

            const item = document.createElement('div');
            item.className = 'fic-card p-4 rounded-xl flex justify-between cursor-pointer relative group mb-3';
            item.onclick = () => openEditModal(f.id);
            
            item.innerHTML = `
                <div class="flex-1 min-w-0 pr-3">
                    <div class="flex items-start justify-between">
                        <span class="badge bg-slate-700 text-slate-300 border border-slate-600 mr-2 mb-1 truncate max-w-[120px]">${f.fandom || 'No Fandom'}</span>
                    </div>
                    ${seriesHtml}
                    <h3 class="font-bold text-lg text-white truncate leading-tight mt-0.5 mb-0.5">${f.title}</h3>
                    <p class="text-xs text-slate-400 mb-2 truncate">${f.author || 'Unknown Author'}</p>
                    <div class="flex flex-wrap items-center gap-2">
                        ${statusBadge}
                        ${coverBadge}
                        ${isRead ? '<span class="text-emerald-400 text-xs flex items-center gap-1"><i class="fa-solid fa-check"></i> Read</span>' : ''}
                        ${f.notes ? '<span class="text-indigo-400 text-xs"><i class="fa-solid fa-note-sticky" title="Has Notes"></i></span>' : ''}
                    </div>
                </div>
                <div class="flex flex-col items-end justify-between pl-2 min-w-[70px] border-l border-slate-700/50 my-1">
                    ${f.originalLink ? 
                        `<button onclick="event.stopPropagation(); window.open('${f.originalLink}', '_blank')" class="text-indigo-400 hover:text-white bg-indigo-500/10 hover:bg-indigo-500 p-1.5 rounded-lg transition-all"><i class="fa-solid fa-up-right-from-square text-xs"></i></button>` 
                        : '<div class="h-6"></div>'
                    }
                    <div class="text-[10px] text-slate-500 text-right font-mono mt-auto">
                        <span class="block">${(f.wordcount||0).toLocaleString()}w</span>
                        ${f.chapters ? `<span class="block">${f.chapters} ch</span>` : ''}
                    </div>
                </div>
            `;
            container.appendChild(item);
        }

        function renderSeriesCard(series, container) {
            const div = document.createElement('div');
            div.className = 'series-folder rounded-xl mb-3 cursor-pointer overflow-hidden';
            
            div.onclick = function(e) {
                if(e.target.closest('.fic-card')) return;
                const content = this.querySelector('.series-content');
                const icon = this.querySelector('.chevron-icon');
                const isHidden = content.classList.contains('hidden');
                if(isHidden) {
                    content.classList.remove('hidden');
                    icon.style.transform = 'rotate(180deg)';
                } else {
                    content.classList.add('hidden');
                    icon.style.transform = 'rotate(0deg)';
                }
            };

            div.innerHTML = `
                <div class="p-4 flex justify-between items-center bg-slate-800/80 backdrop-blur-sm z-10 relative">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="badge bg-indigo-500/20 text-indigo-300 border border-indigo-500/30">Series</span>
                            <span class="text-[10px] text-slate-400 uppercase tracking-wider font-bold">${series.fandom}</span>
                        </div>
                        <h3 class="font-bold text-lg text-white leading-tight">${series.title}</h3>
                        <p class="text-xs text-slate-400 mt-1">${series.items.length} Works â€¢ ${series.totalWords.toLocaleString()} words</p>
                    </div>
                    <div class="pl-4 text-slate-500">
                        <i class="fa-solid fa-chevron-down chevron-icon transition-transform duration-300"></i>
                    </div>
                </div>
                <div class="series-content hidden bg-slate-900/50 p-3 space-y-2 border-t border-slate-700/50 animate-fade-in"></div>
            `;
            const contentBox = div.querySelector('.series-content');
            series.items.forEach(f => renderFicCard(f, contentBox));
            container.appendChild(div);
        }

        function renderDiscovery() {
            const container = document.getElementById('discoveryList');
            const unread = fics.filter(f => (f.rereadStatus || 'unread') !== 'read');
            if (unread.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-10">All fics read! Add more to use Discovery.</div>';
                return;
            }
            const shuffled = unread.sort(() => 0.5 - Math.random()).slice(0, 5);
            container.innerHTML = '';
            shuffled.forEach(f => {
                const card = document.createElement('div');
                card.className = 'fic-card p-5 rounded-xl border border-indigo-500/20 shadow-lg';
                const tagsHtml = (f.tags || []).slice(0, 5).map(t => `<span class="tag-chip">${t}</span>`).join('');
                const shipsHtml = (f.ships || []).map(s => `<span class="text-indigo-300 text-xs font-bold mr-2">${s}</span>`).join('');

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">${f.fandom}</span>
                            <h3 class="text-xl font-bold text-white leading-tight">${f.title}</h3>
                            <p class="text-sm text-slate-400">by ${f.author}</p>
                        </div>
                        ${f.originalLink ? 
                            `<button onclick="window.open('${f.originalLink}', '_blank')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition-colors">Read Now</button>` : ''
                        }
                    </div>
                    <div class="flex flex-wrap gap-2 mb-3">${shipsHtml}${tagsHtml}</div>
                    <div class="bg-slate-900/50 p-3 rounded-lg text-sm text-slate-300 italic mb-3 border-l-2 border-slate-600">${f.summary || 'No summary provided.'}</div>
                    <div class="flex justify-between items-center pt-2 border-t border-slate-700/50">
                        <span class="text-xs text-slate-500 font-mono">${(f.wordcount||0).toLocaleString()} words</span>
                        <button onclick="openEditModal('${f.id}')" class="text-xs text-slate-500 hover:text-white">View Details</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- DASHBOARD (NEW FEATURES) ---
        function updateDashboard() {
            const readFics = fics.filter(f => f.rereadStatus === 'read');
            
            // 1. Big Stats
            document.getElementById('stat-total').innerText = fics.length;
            document.getElementById('stat-words').innerText = readFics.reduce((s, f) => s + (f.wordcount || 0), 0).toLocaleString();
            
            // 2. Progress Bar
            document.getElementById('stat-read-count').innerText = `Read: ${readFics.length}`;
            document.getElementById('stat-unread-count').innerText = `Unread: ${fics.length - readFics.length}`;
            setTimeout(() => {
                const pct = fics.length ? (readFics.length / fics.length) * 100 : 0;
                document.getElementById('stat-progress-bar').style.width = `${pct}%`;
            }, 100);

            // 3. General Stats (Pie Charts)
            const getTop = (list, keyFn) => {
                const counts = {};
                list.forEach(f => {
                    const keys = keyFn(f);
                    if (Array.isArray(keys)) keys.forEach(k => counts[k] = (counts[k] || 0) + 1);
                    else if (keys) counts[keys] = (counts[keys] || 0) + 1;
                });
                return Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5); // Top 5
            };

            drawPie('pie-fandoms', 'legend-fandoms', getTop(readFics, f => f.fandom));
            drawPie('pie-ships', 'legend-ships', getTop(readFics, f => f.ships));
            drawPie('pie-tags', 'legend-tags', getTop(readFics, f => f.tags));

            // 4. Populate Years Dropdown
            const years = new Set();
            readFics.forEach(f => {
                const d = parseDateLocal(f.dateFinished);
                if(d) years.add(d.getFullYear());
            });
            const sortedYears = Array.from(years).sort((a,b) => b-a);
            
            const select = document.getElementById('yearSelect');
            if (select.options.length !== sortedYears.length) { // Simple check to avoid reset loop
                const current = select.value;
                select.innerHTML = '';
                sortedYears.forEach(y => {
                    const opt = document.createElement('option');
                    opt.value = y;
                    opt.innerText = y;
                    select.appendChild(opt);
                });
                if(sortedYears.includes(parseInt(current))) select.value = current;
            }
            
            renderYearlyStats(); // Initial render for current selection
        }

        function drawPie(chartId, legendId, data) {
            const chartEl = document.getElementById(chartId);
            const legendEl = document.getElementById(legendId);
            legendEl.innerHTML = '';
            
            if(data.length === 0) {
                chartEl.style.background = 'conic-gradient(#334155 0% 100%)';
                legendEl.innerHTML = '<span class="text-xs text-slate-500">No data available</span>';
                return;
            }

            const total = data.reduce((sum, item) => sum + item[1], 0);
            const colors = ['#818cf8', '#a78bfa', '#c084fc', '#e879f9', '#f472b6']; // Indigo to Pink
            
            let gradientStr = '';
            let start = 0;

            data.forEach((item, index) => {
                const pct = (item[1] / total) * 100;
                const end = start + pct;
                const color = colors[index % colors.length];
                gradientStr += `${color} ${start}% ${end}%, `;
                start = end;

                // Legend Item
                legendEl.innerHTML += `
                    <div class="flex justify-between items-center text-xs">
                        <div class="flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full" style="background-color: ${color}"></span>
                            <span class="text-slate-300 truncate w-24">${item[0]}</span>
                        </div>
                        <span class="font-bold text-slate-400">${item[1]}</span>
                    </div>`;
            });

            chartEl.style.background = `conic-gradient(${gradientStr.slice(0, -2)})`;
        }

        function renderYearlyStats() {
            const year = parseInt(document.getElementById('yearSelect').value);
            const container = document.getElementById('yearlyStatsContainer');
            
            if (!year) {
                container.innerHTML = '<p class="text-slate-500 text-center text-sm">No years available yet.</p>';
                return;
            }

            const yearlyFics = fics.filter(f => {
                if(f.rereadStatus !== 'read' || !f.dateFinished) return false;
                const d = parseDateLocal(f.dateFinished);
                return d && d.getFullYear() === year;
            });

            const totalWords = yearlyFics.reduce((sum, f) => sum + (f.wordcount || 0), 0);
            
            // Find top fandom for this specific year
            const fandoms = {};
            yearlyFics.forEach(f => fandoms[f.fandom] = (fandoms[f.fandom] || 0) + 1);
            const topFandom = Object.entries(fandoms).sort((a,b) => b[1] - a[1])[0];

            container.innerHTML = `
                <div class="grid grid-cols-2 gap-4 text-center mb-6">
                    <div>
                        <p class="text-xs text-slate-500 uppercase font-bold">Finished</p>
                        <p class="text-2xl font-bold text-white">${yearlyFics.length}</p>
                    </div>
                    <div>
                        <p class="text-xs text-slate-500 uppercase font-bold">Words</p>
                        <p class="text-2xl font-bold text-indigo-400">${totalWords.toLocaleString()}</p>
                    </div>
                </div>
                ${topFandom ? `
                <div class="bg-slate-700/50 p-3 rounded-xl flex justify-between items-center">
                    <span class="text-xs text-slate-400 font-bold uppercase">Obsession of ${year}</span>
                    <span class="badge bg-indigo-500/20 text-indigo-300 border border-indigo-500/30">${topFandom[0]} (${topFandom[1]})</span>
                </div>` : ''}
            `;
        }

        function updateReport() { /* Keep existing report logic if used, omitted for brevity as dashboard replaces need */ }

        // --- HELPERS (Dates, Form, Modal) ---
        function parseDateLocal(input) {
            if(!input) return null;
            if(typeof input === 'number') return new Date((input + 978307200) * 1000);
            if(typeof input === 'string' && input.includes('-') && input.length === 10) {
                const [y, m, d] = input.split('-').map(Number);
                return new Date(y, m - 1, d);
            }
            return new Date(input); 
        }

        function renderSuggestions() { /* Standard suggestion render */
            const shipSet = new Set();
            const tagSet = new Set();
            fics.forEach(f => {
                (f.ships || []).forEach(s => shipSet.add(s));
                (f.tags || []).forEach(t => tagSet.add(t));
            });
            const sortedShips = Array.from(shipSet).sort((a, b) => a.localeCompare(b));
            const sortedTags = Array.from(tagSet).sort((a, b) => a.localeCompare(b));

            const fillSelect = (id, items) => {
                const el = document.getElementById(id);
                el.innerHTML = '<option value="">Select used...</option>';
                items.forEach(i => {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.innerText = i;
                    el.appendChild(opt);
                });
            };
            fillSelect('selShipsHelper', sortedShips);
            fillSelect('selTagsHelper', sortedTags);
        }

        function pickSuggestion(inputId, selectId) {
            const select = document.getElementById(selectId);
            const val = select.value;
            if(!val) return;
            const input = document.getElementById(inputId);
            const current = input.value.trim();
            if(current.length === 0) { input.value = val; } 
            else if(!current.includes(val)) { input.value = current + ', ' + val; }
            select.value = ""; 
        }

        function toggleDateVisibility() {
            const status = document.getElementById('inpReadStatus').value;
            const dateDiv = document.getElementById('divDateFinished');
            if (status === 'read') {
                dateDiv.classList.remove('hidden');
                if(!document.getElementById('inpDateFinished').value) {
                    document.getElementById('inpDateFinished').valueAsDate = new Date();
                }
            } else {
                dateDiv.classList.add('hidden');
            }
        }

        function openAddModal() {
            document.getElementById('ficForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('modalTitle').innerText = 'Add New Fic';
            document.getElementById('btnDelete').classList.add('hidden');
            toggleDateVisibility(); 
            renderSuggestions(); 
            document.getElementById('ficModal').classList.remove('hidden');
        }

        function openEditModal(id) {
            const f = fics.find(x => x.id === id);
            if(!f) return;
            document.getElementById('editId').value = f.id;
            document.getElementById('modalTitle').innerText = 'Edit Fic';
            document.getElementById('inpTitle').value = f.title;
            document.getElementById('inpAuthor').value = f.author || '';
            document.getElementById('inpFandom').value = f.fandom || '';
            document.getElementById('inpLink').value = f.originalLink || '';
            document.getElementById('inpReadStatus').value = f.rereadStatus || 'unread';
            document.getElementById('inpCoverStatus').value = f.coverStatus || 'not';
            document.getElementById('inpStatus').value = f.status || 'wip';
            document.getElementById('inpWords').value = f.wordcount || '';
            document.getElementById('inpChapters').value = f.chapters || '';
            document.getElementById('inpSummary').value = f.summary || '';
            document.getElementById('inpNotes').value = f.notes || '';
            document.getElementById('inpShips').value = (f.ships||[]).join(', ');
            document.getElementById('inpTags').value = (f.tags||[]).join(', ');
            document.getElementById('inpSeries').value = f.series || '';
            document.getElementById('inpSeriesPart').value = f.seriesPart || '';

            const dateInput = document.getElementById('inpDateFinished');
            if(f.dateFinished) {
                if(typeof f.dateFinished === 'string' && f.dateFinished.length === 10) {
                    dateInput.value = f.dateFinished;
                } else {
                    const d = parseDateLocal(f.dateFinished);
                    if(d) dateInput.value = d.toISOString().split('T')[0];
                }
            } else {
                dateInput.value = '';
            }
            
            document.getElementById('btnDelete').classList.remove('hidden');
            toggleDateVisibility(); 
            renderSuggestions(); 
            document.getElementById('ficModal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('ficModal').classList.add('hidden'); }
        
        function deleteFic() {
            if(confirm("Permanently delete this fic?")) {
                const id = document.getElementById('editId').value;
                fics = fics.filter(f => f.id !== id);
                saveData();
                closeModal();
            }
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const readStatus = document.getElementById('inpReadStatus').value;
            const dateVal = document.getElementById('inpDateFinished').value;
            const dateFinished = (readStatus === 'read' && dateVal) ? dateVal : null;

            const obj = {
                id: id || crypto.randomUUID(),
                title: document.getElementById('inpTitle').value,
                author: document.getElementById('inpAuthor').value,
                fandom: document.getElementById('inpFandom').value,
                originalLink: document.getElementById('inpLink').value,
                rereadStatus: readStatus,
                coverStatus: document.getElementById('inpCoverStatus').value,
                status: document.getElementById('inpStatus').value,
                wordcount: parseInt(document.getElementById('inpWords').value) || 0,
                chapters: parseInt(document.getElementById('inpChapters').value) || 0,
                summary: document.getElementById('inpSummary').value,
                notes: document.getElementById('inpNotes').value,
                ships: document.getElementById('inpShips').value.split(',').map(s=>s.trim()).filter(s=>s),
                tags: document.getElementById('inpTags').value.split(',').map(s=>s.trim()).filter(s=>s),
                dateFinished: dateFinished,
                series: document.getElementById('inpSeries').value.trim(),
                seriesPart: parseInt(document.getElementById('inpSeriesPart').value) || 0
            };

            if(id) {
                const idx = fics.findIndex(x => x.id === id);
                fics[idx] = { ...fics[idx], ...obj };
            } else {
                fics.unshift(obj);
            }
            saveData();
            closeModal();
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                try {
                    const json = JSON.parse(ev.target.result);
                    fics = Array.isArray(json) ? json : (json.fics || []);
                    saveData();
                    alert(`Import successful: ${fics.length} fics loaded.`);
                    switchTab('library');
                } catch (err) { alert("Error: Invalid backup file."); }
            };
            reader.readAsText(file);
        }

        function exportData() {
            const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({ database_version: "1.0", fics: fics }, null, 2));
            const a = document.createElement('a');
            a.href = str;
            a.download = "ficlib_backup.json";
            document.body.appendChild(a);
            a.click();
            a.remove();
        }

        function clearData() {
            if(confirm("âš ï¸ Warning: This will delete ALL data.")) { fics = []; saveData(); switchTab('library'); }
        }
    </script>
</body>
</html>
